{% extends "base.html" %} {% block title %}文件上传{% endblock %} {% block
content %}
<div class="container">
    <h1>文件上传</h1>

    <div class="row">
        <div class="col-md-8">
            <!-- 单文件上传 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>上传文件</h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label"
                                >选择文件</label
                            >
                            <input
                                type="file"
                                class="form-control"
                                id="file"
                                name="file"
                                accept=".mp4,.mp3,.wav,.m4a,.srt,.ass,.vtt"
                                required
                            />
                            <small class="form-text text-muted"
                                >支持视频、音频和字幕文件</small
                            >
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label"
                                >描述（可选）</label
                            >
                            <textarea
                                class="form-control"
                                id="description"
                                name="description"
                                rows="2"
                            ></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            上传文件
                        </button>
                    </form>
                    <div id="uploadProgress" class="mt-3" style="display: none">
                        <div class="progress">
                            <div
                                id="progressBar"
                                class="progress-bar"
                                role="progressbar"
                                style="width: 0%"
                            ></div>
                        </div>
                        <small id="progressText" class="text-muted"></small>
                    </div>
                </div>
            </div>

            <!-- URL上传 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>从URL上传</h5>
                </div>
                <div class="card-body">
                    <form id="urlUploadForm">
                        <div class="mb-3">
                            <label for="url" class="form-label">视频URL</label>
                            <textarea
                                class="form-control"
                                id="url"
                                name="url"
                                rows="3"
                                placeholder="支持多条URL，使用换行/空格/逗号分隔"
                                required
                            ></textarea>
                            <small class="form-text text-muted"
                                >支持YouTube、Bilibili、AcFun等平台</small
                            >
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    id="extract_audio"
                                    name="extract_audio"
                                    checked
                                />
                                <label
                                    class="form-check-label"
                                    for="extract_audio"
                                >
                                    同时提取音频文件
                                </label>
                            </div>
                            <div class="form-check">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    id="auto_transcribe"
                                    name="auto_transcribe"
                                />
                                <label
                                    class="form-check-label"
                                    for="auto_transcribe"
                                >
                                    自动转录生成字幕
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">
                            下载并处理
                        </button>
                        <div
                            id="urlStatus"
                            class="form-text text-muted mt-2"
                        ></div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- 最近上传 -->
            <div class="card">
                <div class="card-header">
                    <h5>最近上传</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">最近上传的文件将显示在这里</p>
                    <a
                        href="{{ url_for('view.index') }}"
                        class="btn btn-outline-primary btn-sm"
                        >查看所有文件</a
                    >
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 文件上传处理
    document
        .getElementById("uploadForm")
        .addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const progressDiv = document.getElementById("uploadProgress");
            const progressBar = document.getElementById("progressBar");
            const progressText = document.getElementById("progressText");

            progressDiv.style.display = "block";
            progressText.textContent = "上传中...";

            fetch("/upload/file", {
                method: "POST",
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        alert("文件上传成功！");
                        window.location.href = "/view/" + data.file_id;
                    } else {
                        alert("上传失败: " + data.error);
                    }
                })
                .catch((error) => {
                    alert("上传出错: " + error);
                })
                .finally(() => {
                    progressDiv.style.display = "none";
                });
        });

    function splitUrls(text) {
        return text
            .split(/[\s,，]+/)
            .map((item) => item.trim())
            .filter((item) => item);
    }

    function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
    }

    async function waitForCompletion(processId) {
        var attempts = 0;
        var maxAttempts = 120;
        while (attempts < maxAttempts) {
            attempts += 1;
            try {
                var response = await fetch("/process/status/" + processId);
                if (!response.ok) {
                    await sleep(3000);
                    continue;
                }
                var data = await response.json();
                var status = (data.status || "").toLowerCase();
                if (status === "completed" || status === "failed") {
                    return data;
                }
            } catch (error) {
                // ignore and retry
            }
            await sleep(5000);
        }
        return { status: "timeout" };
    }

    async function submitUrl(url, extractAudio, autoTranscribe) {
        var response = await fetch("/upload/url", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                url: url,
                extract_audio: extractAudio,
                auto_transcribe: autoTranscribe,
            }),
        });

        var data = {};
        try {
            data = await response.json();
        } catch (error) {
            data = {};
        }

        if (data.error) {
            throw new Error(data.error);
        }

        if (data.process_id) {
            var statusData = await waitForCompletion(data.process_id);
            statusData.process_id = data.process_id;
            return statusData;
        }

        return data;
    }

    // URL上传处理
    document
        .getElementById("urlUploadForm")
        .addEventListener("submit", function (e) {
            e.preventDefault();
            handleUrlSubmit();
        });

    async function handleUrlSubmit() {
        var urlText = document.getElementById("url").value;
        var extractAudio = document.getElementById("extract_audio").checked;
        var autoTranscribe = document.getElementById("auto_transcribe").checked;
        var statusEl = document.getElementById("urlStatus");
        var urls = splitUrls(urlText);

        if (urls.length === 0) {
            alert("请输入视频URL");
            return;
        }

        statusEl.textContent =
            urls.length > 1 ? "批量模式已启用，并行处理中。" : "正在处理...";

        if (urls.length === 1) {
            try {
                var singleResult = await submitUrl(
                    urls[0],
                    extractAudio,
                    autoTranscribe,
                );
                if (singleResult.process_id) {
                    window.location.href =
                        "/process/video/" + singleResult.process_id;
                    return;
                }
            } catch (error) {
                alert("处理失败: " + (error.message || String(error)));
                return;
            }
            statusEl.textContent = "处理完成。";
            return;
        }

        var failures = [];
        var completed = 0;
        statusEl.textContent =
            "已提交 " + urls.length + " 条，完成 0/" + urls.length;

        var tasks = urls.map(function (currentUrl) {
            return submitUrl(currentUrl, extractAudio, autoTranscribe)
                .then(function (result) {
                    if (
                        result.status &&
                        result.status.toLowerCase() === "failed"
                    ) {
                        failures.push({
                            url: currentUrl,
                            error: result.error || "处理失败",
                        });
                    }
                    if (
                        result.status &&
                        result.status.toLowerCase() === "timeout"
                    ) {
                        failures.push({ url: currentUrl, error: "处理超时" });
                    }
                })
                .catch(function (error) {
                    failures.push({
                        url: currentUrl,
                        error: error.message || String(error),
                    });
                })
                .finally(function () {
                    completed += 1;
                    statusEl.textContent =
                        "并行处理中 " + completed + "/" + urls.length;
                });
        });

        await Promise.all(tasks);

        if (failures.length > 0) {
            statusEl.textContent =
                "批量处理完成，但有 " + failures.length + " 条失败。";
            alert(
                "处理失败: " +
                    failures
                        .map((item) => item.url + ": " + item.error)
                        .join("；"),
            );
            return;
        }

        statusEl.textContent = "处理完成。";
    }
</script>
{% endblock %}
