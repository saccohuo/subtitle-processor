# Subtitle Processing Service å­—å¹•å¤„ç†æœåŠ¡

[English](#english) | [ä¸­æ–‡](#chinese)

> **Note**: This README is entirely generated by AI and is for reference only.  
> **æ³¨æ„**ï¼šæœ¬ README å®Œå…¨ç”± AI ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒã€‚

### Recent Updates
- `scripts/build-and-push.sh` now reuses persistent BuildKit caches, pushes multi-arch manifests, and reloads the host architecture locally without an extra `docker pull`.
- Telegram webhook handlers now acknowledge requests immediately and move heavy subtitle generation into background tasks, preventing duplicate retries.
- Updated Telegram deployment guidance: keep a single webhook-facing bot instance and let other nodes run only the processing services to avoid duplicate replies.
- Documented the image distribution workflow and `.env` overrides for easier rollout across multiple machines.

<a name="english"></a>
## ğŸŒ English

### Overview
A comprehensive subtitle processing service that automatically downloads, transcribes, and manages video subtitles from various platforms. Features a Telegram bot interface and a web management portal.

### ğŸš€ Features
- **Multi-Platform Support**
  - YouTube video subtitle extraction
  - Bilibili video subtitle processing
  - Automatic fallback to audio transcription
  
- **Subtitle Processing**
  - Direct subtitle download from platforms
  - Audio transcription using FunASR
  - Support for multiple subtitle formats (SRT, VTT, JSON3)
  
- **User Interfaces**
  - Telegram Bot for easy access
  - Web interface for subtitle management
  - Real-time subtitle viewing and searching
  
- **File Management**
  - Automatic file organization
  - Metadata tracking
  - Timeline visualization
- **Deployment Flexibility**
  - Telegram webhook via a single entrypoint, worker nodes run processing-only stack
  - Build script with persistent cache/export to push and reload images quickly
  - `.env` overrides for image tags per environment

- **Readwise Integration**
  - Automatic article creation from subtitles
  - Rich text formatting support
  - Seamless sync with Readwise Reader
  - Smart content segmentation for long videos

### ğŸ› ï¸ Technical Stack
- Backend: Python Flask
- Frontend: HTML/CSS/JavaScript
- Transcription: FunASR
- Container: Docker
- Storage: JSON-based file system

### ğŸ“¦ Installation
1. Clone the repository
2. Install Docker and Docker Compose
3. Configure environment variables:
   ```bash
   TELEGRAM_TOKEN=your_telegram_bot_token
   READWISE_TOKEN=your_readwise_token
   ```
4. Configure Firefox cookies for YouTube access:
   - Copy your Firefox profile directory (located at `C:\Users\<USER_NAME>\AppData\Roaming\Mozilla\Firefox\Profiles\`) to the `firefox_profile` directory in the project
   - This enables downloading restricted YouTube videos using your Firefox login cookies
5. Start the services:
   ```bash
   docker-compose up --build
   ```

### ğŸ§© Distribute Docker Images to Multiple Hosts
1. Generate and push images from a build machine:
   ```bash
   cp images.env.example images.env
   # Edit images.env to set IMAGE_PREFIX (e.g. docker.io/myteam) and IMAGE_TAG
   # Optionally set EXTRA_TAGS=latest if you also want a latest tag
   set -a; source images.env; set +a
   ./scripts/build-and-push.sh
   ```
   The script tags/pushes:
   - `${IMAGE_PREFIX}/subtitle-processor:${IMAGE_TAG}`
   - `${IMAGE_PREFIX}/transcribe-audio:${IMAGE_TAG}`
   - `${IMAGE_PREFIX}/telegram-bot:${IMAGE_TAG}`
2. On each target host, create (or edit) `.env` with the new image references:
   ```env
   SUBTITLE_PROCESSOR_IMAGE=${IMAGE_PREFIX}/subtitle-processor:${IMAGE_TAG}
   TRANSCRIBE_AUDIO_IMAGE=${IMAGE_PREFIX}/transcribe-audio:${IMAGE_TAG}
   TELEGRAM_BOT_IMAGE=${IMAGE_PREFIX}/telegram-bot:${IMAGE_TAG}
   ```
3. Pull and start containers without rebuilding locally:
   ```bash
   docker compose pull
   docker compose up -d --no-build
   ```

### ğŸ¤– Telegram Deployment (Single Entry)
- Choose **one** machine (for example the NAS that fronts Caddy) to run the `telegram-bot` service with webhook enabled. Configure `telegram.webhook.public_url` (or `TELEGRAM_WEBHOOK_*` envs) **only** on this host so it remains the sole webhook endpoint. Start the stack with the Telegram profile:
  ```bash
  docker compose --profile telegram up -d
  ```
- On additional worker machines, keep running `subtitle-processor` and `transcribe-audio` but skip the bot service. You can do this by launching only the needed services:
  The default profile starts only processing services, so a plain `docker compose up -d` works. You can also explicitly target services:
  ```bash
  docker compose up -d subtitle-processor transcribe-audio
  ```
  or comment out the `telegram-bot` section in the workerâ€™s compose file. Setting `TELEGRAM_BOT_ENABLED=false` in the workerâ€™s environment keeps the container in health-check mode if you ever need the image present.
- The worker nodes will still take part in transcription because the primary bot forwards requests to them via the shared FunASR server list in `config/config.yml`.
- This â€œsingle entry + multiple workersâ€ layout prevents Telegram from redelivering the same webhook to different instances, eliminating duplicate replies in chats.
- Each webhook is acknowledged immediately and the heavy lifting runs in background tasks, so Telegram never retries the same update due to timeouts.
- For exceptionally long jobs you can raise the HTTP timeouts via `SUBTITLE_CONNECT_TIMEOUT` (default 120 seconds) and `SUBTITLE_READ_TIMEOUT` (default 1800 seconds). Defaults are defined in `docker-compose.yml` and may be overridden with environment variables if needed.

### ğŸ”§ Usage
1. **Telegram Bot**
   - Send video URL to the bot
   - Receive processed subtitle file
   
2. **Web Interface**
   - Access `http://localhost:5000`
   - Upload video files or URLs
   - View and search subtitles

3. **Readwise Integration**
   - Automatically creates articles in Readwise Reader
   - Preserves video metadata (title, URL, publish date)
   - Intelligently splits long content into readable segments
   - Access transcripts alongside your other reading materials

### ğŸ“ License
MIT License

### ğŸ™ Acknowledgments
Special thanks to:
- [Windsurf](https://github.com/codeium/windsurf) - The world's first agentic IDE that made this project development possible
- Claude 3.5 Sonnet - For providing comprehensive AI assistance throughout the development process

---

<a name="chinese"></a>
## ğŸŒ ä¸­æ–‡

### æ¦‚è¿°
ä¸€ä¸ªç»¼åˆæ€§çš„å­—å¹•å¤„ç†æœåŠ¡ï¼Œå¯ä»¥è‡ªåŠ¨ä¸‹è½½ã€è½¬å½•å’Œç®¡ç†æ¥è‡ªå„ç§å¹³å°çš„è§†é¢‘å­—å¹•ã€‚æä¾› Telegram æœºå™¨äººæ¥å£å’Œç½‘é¡µç®¡ç†é—¨æˆ·ã€‚

### æœ€è¿‘æ›´æ–°
- `scripts/build-and-push.sh` æ”¯æŒæŒç»­åŒ– BuildKit ç¼“å­˜ï¼Œå¤šæ¶æ„æ¨é€åä¼šè‡ªåŠ¨åœ¨æœ¬æœºåŠ è½½å½“å‰æ¶æ„é•œåƒï¼Œæ— éœ€å†æ‰§è¡Œ `docker pull`ã€‚
- Telegram Webhook ç«‹å³è¿”å›ï¼Œå¹¶å°†å­—å¹•å¤„ç†æ”¾åˆ°åå°æ‰§è¡Œï¼Œé¿å…å› ä¸ºé‡è¯•å¯¼è‡´çš„é‡å¤å›å¤ã€‚
- Telegram éƒ¨ç½²æ”¹ä¸ºâ€œå•å…¥å£ + å¤šå·¥ä½œèŠ‚ç‚¹â€æ¨¡å¼ï¼Œé¿å…åŒä¸€æ¡æ¶ˆæ¯è¢«å¤šä¸ª bot å®ä¾‹é‡å¤å›å¤ã€‚
- æ–‡æ¡£è¡¥å……é•œåƒåˆ†å‘ä¸ `.env` è¦†ç›–æŒ‡å¼•ï¼Œä¾¿äºå¤šæœºå™¨å¿«é€Ÿä¸Šçº¿ã€‚

### ğŸš€ åŠŸèƒ½ç‰¹ç‚¹
- **å¤šå¹³å°æ”¯æŒ**
  - YouTube è§†é¢‘å­—å¹•æå–
  - Bilibili è§†é¢‘å­—å¹•å¤„ç†
  - è‡ªåŠ¨éŸ³é¢‘è½¬å½•å¤‡é€‰æ–¹æ¡ˆ
  
- **å­—å¹•å¤„ç†**
  - ç›´æ¥ä»å¹³å°ä¸‹è½½å­—å¹•
  - ä½¿ç”¨ FunASR è¿›è¡ŒéŸ³é¢‘è½¬å½•
  - æ”¯æŒå¤šç§å­—å¹•æ ¼å¼ï¼ˆSRTã€VTTã€JSON3ï¼‰
  
- **ç”¨æˆ·ç•Œé¢**
  - Telegram æœºå™¨äººä¾¿æ·è®¿é—®
  - ç½‘é¡µå­—å¹•ç®¡ç†ç•Œé¢
  - å®æ—¶å­—å¹•æŸ¥çœ‹å’Œæœç´¢
  
- **æ–‡ä»¶ç®¡ç†**
  - è‡ªåŠ¨æ–‡ä»¶ç»„ç»‡
  - å…ƒæ•°æ®è·Ÿè¸ª
  - æ—¶é—´è½´å¯è§†åŒ–
- **éƒ¨ç½²çµæ´»æ€§**
  - Telegram ä»…åœ¨å•ä¸€å…¥å£å¯ç”¨ webhookï¼Œå…¶ä»–èŠ‚ç‚¹ä¸“æ³¨å¤„ç†ä»»åŠ¡
  - æ„å»ºè„šæœ¬å¸¦æŒä¹…ç¼“å­˜ï¼Œæé«˜æ¨é€/æœ¬åœ°åŠ è½½æ•ˆç‡
  - é€šè¿‡ `.env` è¦†ç›–é•œåƒæ ‡ç­¾ï¼Œé€‚é…ä¸åŒç¯å¢ƒ

- **Readwise é›†æˆ**
  - è‡ªåŠ¨ä»å­—å¹•åˆ›å»ºæ–‡ç« 
  - æ”¯æŒå¯Œæ–‡æœ¬æ ¼å¼
  - ä¸ Readwise Reader æ— ç¼åŒæ­¥
  - æ™ºèƒ½åˆ†æ®µå¤„ç†é•¿è§†é¢‘å†…å®¹

### ğŸ› ï¸ æŠ€æœ¯æ ˆ
- åç«¯ï¼šPython Flask
- å‰ç«¯ï¼šHTML/CSS/JavaScript
- è½¬å½•ï¼šFunASR
- å®¹å™¨ï¼šDocker
- å­˜å‚¨ï¼šåŸºäº JSON çš„æ–‡ä»¶ç³»ç»Ÿ

### ğŸ“¦ å®‰è£…æ­¥éª¤
1. å…‹éš†ä»“åº“
2. å®‰è£… Docker å’Œ Docker Compose
3. é…ç½®ç¯å¢ƒå˜é‡ï¼š
   ```bash
   TELEGRAM_TOKEN=ä½ çš„_telegram_æœºå™¨äºº_token
   READWISE_TOKEN=ä½ çš„_readwise_token
   ```
4. é…ç½® Firefox cookies ä»¥è®¿é—® YouTubeï¼š
   - å°† Firefox é…ç½®æ–‡ä»¶ç›®å½•ï¼ˆä½äº `C:\Users\<USER_NAME>\AppData\Roaming\Mozilla\Firefox\Profiles\`ï¼‰å¤åˆ¶åˆ°é¡¹ç›®ä¸­çš„ `firefox_profile` ç›®å½•
   - è¿™ä½¿æ‚¨å¯ä»¥ä½¿ç”¨ Firefox ç™»å½• cookie ä¸‹è½½å—é™åˆ¶çš„ YouTube è§†é¢‘
5. å¯åŠ¨æœåŠ¡ï¼š
   ```bash
   docker-compose up --build
   ```

### ğŸ¤– Telegram å•å…¥å£éƒ¨ç½²
- ä»…åœ¨ä¸€å°æœºå™¨ï¼ˆä¾‹å¦‚æ‰¿è½½ Caddy çš„ NASï¼‰è¿è¡Œ `telegram-bot` å¹¶å¯ç”¨ webhookï¼Œåœ¨è¯¥èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡ä¸­å¡«å†™ `telegram.webhook.public_url`ï¼Œå¹¶ä½¿ç”¨å¸¦æœ‰ `telegram` profile çš„å¯åŠ¨æ–¹å¼ï¼š
  ```bash
  docker compose --profile telegram up -d
  ```
- å…¶ä»–å·¥ä½œèŠ‚ç‚¹åªè¿è¡Œ `subtitle-processor` ä¸ `transcribe-audio`ï¼š
  é»˜è®¤ profile åªä¼šå¯åŠ¨å¤„ç†æœåŠ¡ï¼Œå› æ­¤ç›´æ¥æ‰§è¡Œ `docker compose up -d` å³å¯ï¼›ä¹Ÿå¯ä»¥æ˜¾å¼æŒ‡å®šæœåŠ¡ï¼š
  ```bash
  docker compose up -d subtitle-processor transcribe-audio
  ```
-  æˆ–åœ¨å®ƒä»¬çš„ `docker-compose.yml` ä¸­æ³¨é‡Šæ‰ `telegram-bot` æœåŠ¡ï¼›è‹¥éœ€è¦ä¿ç•™å®¹å™¨ï¼Œå¯åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½® `TELEGRAM_BOT_ENABLED=false`ï¼Œè®©å…¶ä»…æä¾›å¥åº·æ£€æŸ¥è€Œä¸å¤„ç†æ¶ˆæ¯ã€‚
- æ‰€æœ‰èŠ‚ç‚¹å…±äº« `config/config.yml` å†…çš„è½¬å½•æœåŠ¡å™¨åˆ—è¡¨ï¼Œä¸»èŠ‚ç‚¹æ”¶åˆ°è¯·æ±‚åä»ä¼šå§”æ´¾åç«¯ FunASR æœåŠ¡æ‰§è¡Œè½¬å½•ã€‚
- è¯¥æ‹“æ‰‘é˜»æ­¢ Telegram å°†åŒä¸€æ¡ webhook æŠ•é€’ç»™å¤šå°å®ä¾‹ï¼Œä»æ ¹æºä¸Šæ¶ˆé™¤é‡å¤å›å¤ã€‚
- æ¯æ¡ Webhook è¯·æ±‚éƒ½ä¼šç«‹å³å“åº”ï¼Œå­—å¹•ç”Ÿæˆç§»è‡³åå°ä»»åŠ¡æ‰§è¡Œï¼ŒTelegram ä¸ä¼šå› è¶…æ—¶è€Œé‡è¯•ã€‚
- å¦‚æœå¤„ç†è¶…é•¿è§†é¢‘ï¼Œå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ `SUBTITLE_CONNECT_TIMEOUT`ï¼ˆé»˜è®¤ 120 ç§’ï¼‰å’Œ `SUBTITLE_READ_TIMEOUT`ï¼ˆé»˜è®¤ 1800 ç§’ï¼‰è°ƒé«˜å­—å¹•è¯·æ±‚çš„è¿æ¥/è¯»å–è¶…æ—¶ã€‚é»˜è®¤å€¼å†™åœ¨ `docker-compose.yml`ï¼Œéœ€è¦æ—¶å¯åœ¨ç¯å¢ƒå˜é‡ä¸­è¦†ç›–ã€‚

### ğŸ§© å¤šæœºå¿«é€Ÿåˆ†å‘ Docker é•œåƒ
1. åœ¨æ„å»ºæœºå™¨ä¸Šç”Ÿæˆå¹¶æ¨é€é•œåƒï¼š
   ```bash
   cp images.env.example images.env
   # ç¼–è¾‘ images.envï¼Œè®¾ç½® IMAGE_PREFIXï¼ˆå¦‚ docker.io/myteamï¼‰å’Œ IMAGE_TAG
   # å¦‚éœ€åŒæ—¶æ¨é€ latestï¼Œå¯è®¾ç½® EXTRA_TAGS=latest
   set -a; source images.env; set +a
   ./scripts/build-and-push.sh
   ```
   è„šæœ¬ä¼šæ¨é€ä»¥ä¸‹é•œåƒï¼š
   - `${IMAGE_PREFIX}/subtitle-processor:${IMAGE_TAG}`
   - `${IMAGE_PREFIX}/transcribe-audio:${IMAGE_TAG}`
   - `${IMAGE_PREFIX}/telegram-bot:${IMAGE_TAG}`
2. åœ¨æ¯å°ç›®æ ‡æœºå™¨æ ¹ç›®å½•åˆ›å»ºï¼ˆæˆ–ä¿®æ”¹ï¼‰`.env` æ–‡ä»¶ï¼Œå¡«å…¥æœ€æ–°é•œåƒï¼š
   ```env
   SUBTITLE_PROCESSOR_IMAGE=${IMAGE_PREFIX}/subtitle-processor:${IMAGE_TAG}
   TRANSCRIBE_AUDIO_IMAGE=${IMAGE_PREFIX}/transcribe-audio:${IMAGE_TAG}
   TELEGRAM_BOT_IMAGE=${IMAGE_PREFIX}/telegram-bot:${IMAGE_TAG}
   ```
3. æ‹‰å–å¹¶å¯åŠ¨å®¹å™¨ï¼Œé¿å…æœ¬åœ°é‡æ–°æ„å»ºï¼š
   ```bash
   docker compose pull
   docker compose up -d --no-build
   ```

### ğŸ”§ ä½¿ç”¨æ–¹æ³•
1. **Telegram æœºå™¨äºº**
   - å‘æœºå™¨äººå‘é€è§†é¢‘ URL
   - æ¥æ”¶å¤„ç†å¥½çš„å­—å¹•æ–‡ä»¶
   
2. **ç½‘é¡µç•Œé¢**
   - è®¿é—® `http://localhost:5000`
   - ä¸Šä¼ è§†é¢‘æ–‡ä»¶æˆ– URL
   - æŸ¥çœ‹å’Œæœç´¢å­—å¹•

3. **Readwise é›†æˆ**
   - è‡ªåŠ¨åœ¨ Readwise Reader ä¸­åˆ›å»ºæ–‡ç« 
   - ä¿ç•™è§†é¢‘å…ƒæ•°æ®ï¼ˆæ ‡é¢˜ã€URLã€å‘å¸ƒæ—¥æœŸï¼‰
   - æ™ºèƒ½åˆ†å‰²é•¿å†…å®¹ä¸ºæ˜“è¯»ç‰‡æ®µ
   - åœ¨å…¶ä»–é˜…è¯»ææ–™æ—è¾¹è®¿é—®è½¬å½•æ–‡æœ¬

### ğŸ“ è®¸å¯è¯
MIT è®¸å¯è¯

### ğŸ™ è‡´è°¢
ç‰¹åˆ«æ„Ÿè°¢ï¼š
- [Windsurf](https://github.com/codeium/windsurf) - ä¸–ç•Œé¦–ä¸ªæ™ºèƒ½ä»£ç† IDEï¼Œä½¿æœ¬é¡¹ç›®çš„å¼€å‘æˆä¸ºå¯èƒ½
- Claude 3.5 Sonnet - åœ¨æ•´ä¸ªå¼€å‘è¿‡ç¨‹ä¸­æä¾›å…¨é¢çš„ AI è¾…åŠ©
