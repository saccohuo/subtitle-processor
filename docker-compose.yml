version: "3.8"

services:
  subtitle-processor:
    build: # 直接运行、不构建的时候，注释掉
      context: .
    image: ${SUBTITLE_PROCESSOR_IMAGE:-subtitle-processor:latest}
    container_name: subtitle-processor
    restart: unless-stopped
    # deploy 部分仅在具备 NVIDIA GPU runtime 时启用
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    ports:
      - "6000:5000" # Web 界面 (临时映射到宿主6000)
      # - "5001:5900" # VNC 服务端口（如需启用图形界面可取消注释）
    volumes:
      # - /share/homes/hsk/subtitle-processor/uploads:/app/uploads
      # - /share/homes/hsk/subtitle-processor/videos:/app/videos
      # - /share/homes/hsk/subtitle-processor/outputs:/app/outputs
      # - /share/homes/hsk/subtitle-processor/config:/app/config
      # - /share/homes/hsk/subtitle-processor/models:/app/models
      # - /share/homes/hsk/subtitle-processor/firefox_profile:/root/.mozilla/firefox  # Firefox 配置目录
      - ./app:/app/app # 映射应用代码
      - ./uploads:/app/uploads
      - ./videos:/app/videos
      - ./outputs:/app/outputs
      - ./config:/app/config
      - ./firefox_profile:/root/.mozilla/firefox # Firefox cookie目录
    environment:
      - TZ=Asia/Shanghai
      - FLASK_APP=run_app.py
      - FLASK_ENV=development
      - STORAGE_BACKEND=redis
      - REDIS_URL=redis://redis:6379/0
      - REDIS_KEY_PREFIX=subtitle_processor
      # 热词策略可选开关
      - HOTWORD_MODE=curated # user_only/curated/experiment
      # - HOTWORD_MAX_COUNT=20           # 自动热词最大数量
      - ENABLE_AUTO_HOTWORDS=true # 启用自动热词生成
      - ENABLE_HOTWORD_POST_PROCESS=true
      # - HOTWORD_POST_SIMILARITY=0.82
      # - ENABLE_HOTWORD_SUBSTRING=false
      # 只对外部请求使用代理
      # - NO_PROXY=subtitle-processor,telegram-bot,transcribe-audio,redis,bgutil-provider,localhost,127.0.0.1
      # - ALL_PROXY=http://host.docker.internal:10808
      # - HTTP_PROXY=http://host.docker.internal:10808
      # - HTTPS_PROXY=http://host.docker.internal:10808
      # 从配置文件读取所有配置
      - CONFIG_PATH=/app/config/config.yml
      - BGUTIL_PROVIDER_URL=${BGUTIL_PROVIDER_URL:-http://bgutil-provider:4416}
      - YT_DLP_EXTRACTOR_ARGS=youtubepot-bgutilhttp:base_url=http://bgutil-provider:4416
      - YTDLP_PLAYER_CLIENTS=tv,web_safari,web

    networks:
      - srt-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - bgutil-provider
      - redis
    #   - deeplx

  transcribe-audio:
    build: # 直接运行、不构建的时候，注释掉
      context: ./transcribe-audio
      dockerfile: Dockerfile
    image: ${TRANSCRIBE_AUDIO_IMAGE:-transcribe-audio:latest}
    container_name: transcribe-audio
    restart: unless-stopped
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    ports:
      - "10095:10095" # API 服务端口
    volumes:
      # - /share/homes/hsk/subtitle-processor/uploads:/app/uploads
      # - /share/homes/hsk/subtitle-processor/videos:/app/videos
      # - /share/homes/hsk/subtitle-processor/models:/app/models
      # - /share/homes/hsk/subtitle-processor/outputs:/app/outputs
      # - /share/homes/hsk/subtitle-processor/config:/app/config
      - ./uploads:/app/uploads
      - ./videos:/app/videos
      - ./outputs:/app/outputs
      - ./config:/app/config
      - ./models:/app/runtime-models
      - ./transcribe-audio/logs:/app/logs
    environment:
      - TZ=Asia/Shanghai
      - FLASK_APP=app.py
      - FLASK_ENV=development
      - MODEL_DIR=/app/runtime-models
      - MODELSCOPE_CACHE=/app/runtime-models
      - HF_HOME=/app/runtime-models
      - TORCH_HOME=/app/runtime-models
      - FUNASR_MODEL=paraformer-zh
      - FUNASR_VAD_MODEL=fsmn-vad
      - FUNASR_PUNC_MODEL=ct-punc
      # 从配置文件读取所有配置
      - CONFIG_PATH=/app/config/config.yml
      # FunASR 热词后处理（默认关闭）
      # - ENABLE_HOTWORD_POST_PROCESS=true
      # - HOTWORD_POST_SIMILARITY=0.85
      # - ENABLE_HOTWORD_SUBSTRING=true
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - srt-network

  bgutil-provider:
    build:
      context: ./docker-config/bgutil
      dockerfile: Dockerfile
    container_name: bgutil-provider
    restart: unless-stopped
    ports:
      - "4416:4416"
    networks:
      - srt-network

  redis:
    image: redis:7-alpine
    container_name: subtitle-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ./redis-data:/data
    networks:
      - srt-network

  # deeplx:
  #   image: ghcr.io/owo-network/deeplx:latest
  #   container_name: deeplx
  #   restart: unless-stopped
  #   ports:
  #     - "1188:1188"
  #   networks:
  #     - srt-network

  telegram-bot:
    # profiles: [telegram]
    build: # 直接运行、不构建的时候，注释掉
      context: ./telegram-bot
      dockerfile: Dockerfile
    image: ${TELEGRAM_BOT_IMAGE:-telegram-bot:latest}
    container_name: telegram-bot
    restart: always # 改为always，确保任何情况下都重启
    ports:
      - "8082:8082" # Webhook 监听端口（启用 Webhook 时需要）
    environment:
      - TZ=Asia/Shanghai
      - SUBTITLE_PROCESSOR_URL=http://subtitle-processor:5000
      - TELEGRAM_WEBHOOK_ENABLED=true
      - TELEGRAM_WEBHOOK_PORT=8082
      - TELEGRAM_WEBHOOK_LISTEN=0.0.0.0
      - TELEGRAM_WEBHOOK_PATH=/telegram/webhook
      - TELEGRAM_BOT_ENABLED=${TELEGRAM_BOT_ENABLED:-true}
      - SUBTITLE_CONNECT_TIMEOUT=${SUBTITLE_CONNECT_TIMEOUT:-120}
      - SUBTITLE_READ_TIMEOUT=${SUBTITLE_READ_TIMEOUT:-1800}
      # - NO_PROXY=subtitle-processor,localhost,127.0.0.1
      # - ALL_PROXY=http://host.docker.internal:20172
      # - HTTP_PROXY=http://host.docker.internal:20172
      # - HTTPS_PROXY=http://host.docker.internal:20172
      # 从配置文件读取所有配置
      - CONFIG_PATH=/app/config/config.yml
    volumes:
      - ./config:/app/config
      # - /share/homes/hsk/subtitle-processor/config:/app/config
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import requests; requests.get(''http://localhost:8081/health'', timeout=10)" || exit 1',
        ]
      interval: 60s # 每60秒检查一次
      timeout: 10s # 检查超时10秒
      retries: 3 # 失败3次后认为不健康
      start_period: 60s # 启动后60秒开始检查
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    networks:
      - srt-network
    depends_on:
      - subtitle-processor
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  srt-network:
    driver: bridge
